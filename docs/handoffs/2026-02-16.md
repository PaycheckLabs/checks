# Checks Contracts CI Reset Handoff — 2026-02-16

## 1) Current Situation
We were stuck in a loop where every commit after introducing the contracts CI workflow failed. To break the loop, `main` was reset back to the last known-good commit (the last stable contracts state before the CI experiment). A backup branch was created that still contains the old “pre-reset” history.

Goal now is to reintroduce CI in a clean, minimal, contracts-only way, starting from a locally passing baseline.

## 2) Repo Links
- Repo: https://github.com/PaycheckLabs/checks
- Last known-good commit (target baseline): https://github.com/PaycheckLabs/checks/commit/caeef214fe4f7db53ee57724b2b252cf3298aedd
- Backup branch (pre-reset history): `backup/main-before-reset` (delete later once stable)

## 3) What Is True on main Right Now
- Contracts live under `packages/contracts`
- Foundry config is `packages/contracts/foundry.toml`
- Contracts source is `packages/contracts/src`
- Tests exist under `packages/contracts/test`
- The problematic `packages/contracts/src/contracts` path is NOT part of the baseline
- The contracts CI workflow file is currently not present on main

## 4) Primary Objective
Get the first clean green CI run by:
1) Confirming `forge build` and `forge test` pass locally from `packages/contracts`
2) Adding a minimal `.github/workflows/contracts.yml` that runs Foundry only (no pnpm)
3) Ensuring CI runs only when contracts-related files change

## 5) Local Baseline Verification (Windows)
Run these from repo root:

### PowerShell
- cd .\packages\contracts
- forge --version
- forge build
- forge test -vvv

### Git Bash
- cd packages/contracts
- forge --version
- forge build
- forge test -vvv

If local fails, fix the Solidity or Foundry config first before adding CI.

## 6) Minimal Contracts CI Workflow (Paste Ready)
Create file:
`.github/workflows/contracts.yml`

Use this exact content:

name: Contracts
on:
  push:
    paths:
      - "packages/contracts/**"
      - ".github/workflows/contracts.yml"
  pull_request:
    paths:
      - "packages/contracts/**"
      - ".github/workflows/contracts.yml"

jobs:
  test:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: packages/contracts
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Foundry
        uses: foundry-rs/foundry-toolchain@v1
        with:
          version: stable

      - name: Forge build
        run: forge build --sizes

      - name: Forge test
        run: forge test -vvv

Notes:
- The working-directory is the key. This prevents Foundry from “missing” the correct foundry.toml.
- Do not use `--contracts src/contracts`. Baseline uses `src`.

## 7) After First Green CI Run
Only after CI is green:
- Re-apply the spec-lock edits one by one (referenceId rename, VOID rules, etc.)
- Keep changes small and confirm CI stays green after each commit

## 8) Backup Branch Plan
Keep `backup/main-before-reset` until:
- CI is stable and green on main
- We confirm no needed code exists only in the backup history

Then delete the backup branch to reduce clutter.

## 9) Notes for Next Chat
We should start the new chat focused on:
- Confirming local Foundry pass
- Adding minimal CI workflow
- Locking down the PaymentChecks spec changes in small steps

## 10) Closeout
We are no longer debugging inside a broken CI loop. The workflow is to validate locally first, then add minimal CI, then iterate changes with CI protection.
